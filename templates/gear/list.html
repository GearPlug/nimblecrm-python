{% extends 'layouts/console_base.html' %}
{% load static i18n %}

{% block content %}
    <div class="context-menu" id="context-menu" style="display: none;">
        <a id="menu-editar-gear" href="#!">
            <div class="menu-item">
                Editar Gear
            </div>
        </a>
        <a href="#!">
            <div class="menu-item">
                Editar Grupo
            </div>
        </a>
        <div class="menu-separator"></div>
        <a href="{% url 'connection:connector_list' type='source' %}">
            <div class="menu-item">
                Editar Origen
            </div>
        </a>
        <div class="menu-separator"></div>
        <a href="{% url 'connection:connector_list' type='target' %}">
            <div class="menu-item">
                Editar Destino
            </div>
        </a>
    </div>
    <div class="row projects">
        <div class="title">
            <span>{% trans 'Proyectos' %}</span>
        </div>
        {% if not object_list %}
            <div data-toggle="modal" data-target="#group-modal">
                <div class="add-wrapper">
                    <div class="add">
                        <div class="image">
                            <img src="{% static 'img/console/path6684.png' %}" width="176">
                        </div>
                        <div class="text">
                            Crear Grupo
                        </div>
                    </div>
                    <div class="steps-tooltip">
                        <div class="bar"></div>
                        <div class="box">
                            <div class="text">
                                Crear un grupo donde dirigir√°s todos tus gears.
                            </div>
                        </div>
                        <div class="image">
                            <img src="{% static 'img/console/g6712.png' %}" width="45">
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="folders">
                {% for group in object_list %}
                    {% include 'gear/snippets/group.html' with id=group.id name=group.name columns=2 %}
                {% endfor %}
                {% if object_list %}
                    <div class="add col-md-1">
                        <div class="button">
                            <div data-toggle="modal" data-target="#group-modal">
                                <img src="{% static 'img/console/new_group.png' %}" width="98" height="80">
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    {% if object_list %}
        <div class="row gears">
            <div class="title">
                <span>{% trans 'Gears' %}</span>
            </div>
            <div class="row list">
                {% for group in object_list %}
                    <div class="group-gear" data-group-id="{{ group.id }}" style="display: block;"
                         id="group_gear_{{ group.id }}" data-show="True">
                        {% for gear in group.gear.all %}
                            {% include 'gear/snippets/gear_extend.html' with id=gear.id name=gear.name source=gear.source.connection.connector.icon.url target=gear.target.connection.connector.icon.url %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>

            <div class="row add">
                <div data-toggle="modal" data-target="#gear-modal">
                    <div class="button"><img src="{% static 'img/console/g3261.png' %}" width="38"></div>
                    <div class="text">{% trans 'Nuevo Gear' %}</div>
                </div>
            </div>
        </div>
    {% endif %}

    {% include 'gear/snippets/gear_form.html' %}
    {% include 'gear/snippets/group_form.html' with form=geargroup_form %}
{% endblock %}

{% block scripts %}
    <script type="application/javascript">
        $(document).ready(function () {
            var is_blocked = false;
            $("a.toggle-gear-btn").click(function () {
                var a = $(this);
                var url = a.attr('href');
                if (is_blocked == false) {
                    is_blocked = true;
                    $.ajax({
                        method: "POST", url: url
                    }).done(function (response) {
                        if (response.data == true) {
                            $(a).find("div.button").html('<img src="{% static "img/console/g3317.png" %}" width="36" ' +
                                '"height="36"> <div class="status">ON</div>');
                        } else if (response.data == false) {
                            $(a).find("div.button").html('<img src="{% static "img/console/g3333.png" %}" width="36" ' +
                                '"height="36"> <div class="status">OFF</div>');
                        } else {
                            $(a).find("div.button").html('<img src="{% static "img/console/g3333.png" %}" width="36" ' +
                                '"height="36"> <div class="status">UNEXPECTED ERROR</div>');
                        }
                        is_blocked = false;
                    });
                }
                return false;
            });

            $('div.folders div.item div.image img').on('click', function () {
                var that = $(this).parent().parent();
                var gear_list = $("#group_gear_" + $(that).attr('data-group-id'));
                var show = $(gear_list).attr('data-show');
                if (show == "True") {
                    gear_list.hide();
                    gear_list.attr('data-show', 'False');
                    $(this).attr('src', '{% static "img/console/g3277.png" %}');
                } else {
                    gear_list.show();
                    gear_list.attr('data-show', 'True');
                    $(this).attr('src', '{% static "img/console/g3205.png" %}');
                }
            });

            $('form#group-form, form#gear-form').on('submit', function (e) {
                e.preventDefault();
                $.ajax({
                    method: $(this).attr('method'), url: $(this).attr('action'), data: $(this).serialize()
                }).done(function (response) {
                    if (response.next_url) {
                        location.href = response.next_url;
                    } else {
                        console.log(response)
                    }
                });
                return false;
            });

            $('.edit').click(function (e) {
                var gear_id = $(this).closest('.item').data('gear-id');
                $.ajax({
                    method: "POST",
                    url: '{% url 'gear:set_gear_session' %}',
                    data: {'gear_id': gear_id}
                }).done();

                e.stopPropagation();
                var left = e.pageX - $('.content-body').offset().left;
                var top = e.pageY - $('.content-body').offset().top;

                $('#context-menu').hide();
                $('#context-menu').css({
                    'top': top,
                    'left': left,
                    'position': 'absolute'
                });
                $('div#context-menu a#menu-editar-gear').attr('href', '{% url "gear:update" pk=1234 %}'.replace('1234', gear_id));
                $('#context-menu').show();
            });

            $(document).click(function (e) {
                if ($('#context-menu').is(':visible')) {
                    $('#context-menu').hide();
                }
            })

        });
    </script>
{% endblock %}
