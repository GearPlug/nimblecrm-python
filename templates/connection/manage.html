{% extends 'layouts/console_base.html' %}
{% load static i18n %}
{% block content %}
    <div class="row management">
        <div class="title">
            <span>{% trans 'Administrar Conexiones' %}</span>
        </div>
        <div class="row list">
            {% for connections in object_list %}
                {% with connector=connections.0.connector %}
                    {% for connection in connections %}
                        <div class="row">
                            <div class="col-md-5 item extended">
                                <div class="image-wrapper">
                                    <div class="image">
                                        <div class="connector">
                                            {% with icon73=connector.icon73 %}
                                                {% if icon73 %}
                                                    <img src="{{ icon73.url }}" width="36" height="36">
                                                {% else %}
                                                    <img src="{% static 'img/console/unknown_plug.png' %}" width="36"
                                                         height="36">
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    </div>
                                    <div class="name">
                                        {{ connection.related_connection.name }}
                                    </div>
                                    <div class="control">
                                        <a href="javascript:popUp('{% url "connection:update" pk=connection.id %}')">
                                            <div class="edit">
                                                <img src="{% static 'img/console/g3125.png' %}" width="34">
                                            </div>
                                        </a>
                                        <div class="status">
                                            {{ c.is_active|yesno:'Activo,Desactivado' }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 test-button">
                                <div class="button testConnectionButton"
                                     connection_id="{{ connection.id }}">
                                </div>
                                <div class="text-wrapper" style="display: none;">
                                    <div class="text-line"></div>
                                    <div class="text">
                                        Ésta conexión <b>funciona</b>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% endwith %}
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script type="application/javascript">
        function popUp(url) {
            var win = window.open(url, 'Update Connection', 'width=972,height=660,modal=yes,alwaysRaised=yes');
            var checkConnect = setInterval(function () {
                if (!win || !win.closed) return;
                clearInterval(checkConnect);
                window.location.reload();
            }, 100);
        }

        $('.testConnectionButton').click(function (e) {
            var button = $(this);
            var connector_id = 1;
            $.ajax({
                method: "POST",
                url: "{% url 'connection:test' connector_id=1 %}",
                data: {connection_id: $(button).attr('connection_id')},
            }).done(function (response) {
                if (response.test == true)
                    $(button).css('background-color', 'green');
                else
                    $(button).css('background-color', 'red');

            });
            return false;
        })
    </script>
{% endblock %}
